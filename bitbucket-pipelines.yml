image: python:3.6.0

.pipenv_install: &pipenv_install 
  script:
    - pip install --user pipenv
    - export PATH=$PATH:/root/.local/bin > /root/.profile
    - pipenv install --dev


pipelines:
  default:
    - parallel:
      - step:
          name: Tests
          caches:
            - pipenv
          <<: *pipenv_install   
          script:            
            - apt-get update;
            - apt-get install -y gdal-bin node-less;
            - pipenv shell
            - pytest --cov --cov-config .coveragerc --junitxml=../test-results/xunit-result-master.xml;
      - step:
          name: Flake8 on changed files
          caches:
            - pipenv
          <<: *pipenv_install 
          script:            
            - pipenv shell
            - git fetch origin master:master
            - ./scripts/flake8.sh
#      - step:
#          name: Jscpd report
#          image: node:10.15-alpine
#          caches:
#            - wgnode
#          script:
#            - apt-get install npm
#            - npm install; npm run jscpd || true; # "|| true" means "Allow to fail"
#          artifacts:
#            - report/*.html
definitions:
  caches:
    pipenv: /root/.local/share/virtualenvs
    wgnode: node_modules/
