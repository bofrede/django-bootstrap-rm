pipelines:
  default:  
    - step:
        name: Build
        image: python:3.6.0
        caches:
          - pipenv
        script:
          - pip install --user pipenv
          - export PATH=$PATH:/root/.local/bin > /root/.profile
          - pipenv install --dev
    - parallel:
      - step:
          name: PyTest
          image: python:3.6.0
          caches:
            - pipenv
          script:            
            - apt-get update;
            - apt-get install -y gdal-bin node-less;
            - pip install --user pipenv
            - export PATH=$PATH:/root/.local/bin > /root/.profile
            - pipenv run pytest --cov --cov-config .coveragerc --junitxml=../test-results/xunit-result-master.xml;
      - step:
          name: Flake8
          image: python:3.6.0
          caches:
            - pipenv
          script:   
            - pip install --user pipenv
            - export PATH=$PATH:/root/.local/bin > /root/.profile
            - pipenv run flake8
      - step:
          name: Jscpd report
          image: node:10.15-alpine
          caches:
            - wgnode
          script:
            - npm install; npm run jscpd || true; # "|| true" means "Allow to fail"
          artifacts:
            - report/*.html
definitions:
  caches:
    pipenv: /root/.local/share/virtualenvs
    wgnode: node_modules/
